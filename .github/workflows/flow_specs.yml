name: Flows

on:
  workflow_dispatch:
    inputs:
      sha:
        description: Git reference commit
        type: string
        required: true

  workflow_call:
    inputs:
      sha:
        description: Git reference commit
        type: string
        required: true
      is_workflow_call:
        description: 'Is workflow call?'
        type: string
        required: false
        default: 'true'

  issue_comment:
    types: [ created ]

jobs:
  check_necessity:
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'workflow_dispatch') ||
      (inputs.is_workflow_call == 'true') ||
      (
        github.event.issue.pull_request &&
        (
          contains(github.event.comment.body, '@toptal-bot run ') &&
          (
            contains(github.event.comment.body, 'flows tests') ||
            contains(github.event.comment.body, 'backend pact') ||
            contains(github.event.comment.body, 'default') ||
            contains(github.event.comment.body, 'mergecheck')
          )
        )
      )
    outputs:
      conclusion: ${{ steps.conclusion.outputs.conclusion }}
    steps:
      - name: JSON github
        run: |
          echo $context | jq --color-output .
        env:
          context: ${{ toJSON(github) }}
      - name: JSON event
        run: |
          echo $context | jq --color-output .
        env:
          context: ${{ toJSON(github.event) }}

      - name: Checkout platform
        uses: actions/checkout@v3

      - name: Get merge commit SHA
        if: github.event_name == 'issue_comment'
        id: prData
        uses: ./.github/actions/get_merge_commit/
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v37
        with:
          files_ignore: |
             **/yarn.lock
             **/package.json
             docs/**
             **/*.md
             **/*.js
             **/*.ejs
             **/*.jsx

      - name: Check if any files have changed
        id: conclusion
        env:
          any_changed: ${{ steps.changed-files.outputs.any_changed }}
        run: |
          if [ $any_changed == 'true' ] ; then
            echo "Backend files have changed."
            echo "List all the files that have changed: ${{ steps.changed-files.outputs.all_changed_files }}"
            echo "conclusion=continue" >> $GITHUB_OUTPUT
          else
            echo "No backend files have changed. Skip flows tests."
          fi

  flows:
    name: ${{ matrix.mode }}
    needs: check_necessity
    if: ${{ !cancelled() && needs.check_necessity.outputs.conclusion == 'continue' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mode: [ explore, test ]
    steps:
      - name: Checkout platform
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.sha ||  github.sha }}

      - name: Run flows ${{ matrix.mode }}
        run: |
          echo "${{ needs.check_necessity.outputs.conclusion }}"
          echo "Done"
