name: Trigger phrase

on:
  issue_comment:
    types: [ created ]
jobs:
  first_job:
    if: github.event_name == 'issue_comment'
    runs-on: ubuntu-latest
    name: "Echo 1"
    outputs:
      ANVIL_BUILD_ID: ${{ steps.first_step.outputs.anvil_build_id }}
    steps:
      - id: get-branch-from-issue
        run: echo ::set-output name=branch::$(gh pr view $PR_NO --repo $REPO --json headRefName --jq '.headRefName')
        env:
          REPO: ${{ github.repository }}
          PR_NO: ${{ github.event.issue.number }}
          GITHUB_TOKEN: ${{ secrets.GHA_TEST_REPO }}

      - name: "SET CURRENT_BRUNCH"
        id: first_step
        run: |
          echo "${{ steps.get-branch-from-issue.outputs.branch }}"
          echo "CURRENT_BRUNCH=${{ steps.get-branch-from-issue.outputs.branch }}" >> $GITHUB_ENV
      - run: |
          echo "${{ env.CURRENT_BRUNCH }}

  run_platform_features:
    name: Trigger action and react on comment
    runs-on: ubuntu-latest
    needs: first_job
    if: >
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@toptal-bot run features GHA')
    steps:
      - name: Print
        env :
          CONTENT : "${{ toJson(github.event.issue.pull_request) }}"
          CONTENT1 : "${{ toJson(github.event.issue) }}"
          CONTENT2 : "${{ toJson(github.event) }}"
          CONTENT3 : "${{ toJson(github.event.comment.body) }}"
          CONTENT4 : "${{ toJson(github.event.issue.number ) }}"

        run: |
          echo "Say Hello"
          echo $CONTENT
          echo $CONTENT1
          echo $CONTENT2
          echo $CONTENT3
          echo $CONTENT4
          echo $GITHUB_BASE_REF
          echo ${{ github.base_ref }}
          echo ${{ github.ref }}
          echo ${{ github.ref_name }}
          echo ${{ github.sha }}
          

      - name: React to comment - success or failure
        if: ${{ always() }}
        env:
          JOB_STATUS: ${{ job.status }}
        uses: actions/github-script@v5
        with:
          github-token: ${{ secrets.GHA_TEST_REPO }}
          script: |
            const { owner, repo } = context.issue;
            const content = process.env.JOB_STATUS === 'success' ? '+1' : '-1'
            await github.rest.reactions.createForIssueComment({ owner, repo, comment_id: context.payload.comment.id, content });
#      - run: |
#          exit 1
